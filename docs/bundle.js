(()=>{"use strict";var t={},e={};function n(i){var r=e[i];if(void 0!==r)return r.exports;var o=e[i]={exports:{}};return t[i](o,o.exports,n),o.exports}n.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}();class i{constructor(t,e,n,i){this.t="none",this.x=t,this.y=e,this.width=n,this.height=i}read(t=0,e=0,n=this.width,i=this.height){throw new Error("This imgref ("+this.t+") does not support toData")}findSubimage(t,e=0,n=0,i=this.width,o=this.height){return function(t,e,n=0,i=0,o=t.width,a=t.height){if(!t)throw new TypeError;if(!e)throw new TypeError;if(t instanceof r&&d&&alt1.bindFindSubImg){var s=function(t,e=0,n=0,i=t.width,r=t.height){for(var o="",a=n;a<n+r;a++)for(var s=e;s<e+i;s++){var h=4*s+4*t.width*a|0;o+=String.fromCharCode(t.data[h+2|0]),o+=String.fromCharCode(t.data[h+1|0]),o+=String.fromCharCode(t.data[h+0|0]),o+=String.fromCharCode(t.data[h+3|0])}return btoa(o)}(e),h=alt1.bindFindSubImg(t.handle,s,e.width,n,i,o,a);if(!h)throw new l;return JSON.parse(h)}return function(t,e,n=0,i=0,r=t.width,o=t.height){for(var a=[],s=4*e.width,h=4*t.width,l=[],d=0;d<e.height;d++){for(var c=0;c<e.width;c++){var u=4*c+d*s;if(255==e.data[u+3]&&l.push({x:c,y:d}),10==l.length)break}if(10==l.length)break}var g=n+r-e.width,f=i+o-e.height,m=l.length;for(d=i;d<=f;d++)t:for(c=n;c<=g;c++){for(var p=0;p<m;p++){var w=4*(c+l[p].x)+(d+l[p].y)*h,v=4*l[p].x+l[p].y*s,x=0;if(x=(x=(x=x+Math.abs(t.data[w+0]-e.data[v+0])|0)+Math.abs(t.data[w+1]-e.data[v+1])|0)+Math.abs(t.data[w+2]-e.data[v+2])|0,(x*=255/e.data[v+3])>30)continue t}if(y(t,e,c,d,30)!=1/0&&(a.push({x:c,y:d}),a.length>50))return a}return a}(t.read(),e,n,i,o,a)}(this,t,e,n,i,o)}toData(t=this.x,e=this.y,n=this.width,i=this.height){return this.read(t-this.x,e-this.y,n,i)}containsArea(t){return this.x<=t.x&&this.y<=t.y&&this.x+this.width>=t.x+t.width&&this.y+this.height>=t.y+t.height}}class r extends i{constructor(t,e=0,n=0,i=0,r=0){super(e,n,i,r),this.handle=t,this.t="bind"}read(t=0,e=0,n=this.width,i=this.height){return function(t,e,n,i,r){if(e=Math.round(e),n=Math.round(n),i=Math.round(i),r=Math.round(r),u(),alt1.bindGetRegionBuffer)return new o(alt1.bindGetRegionBuffer(t,e,n,i,r),i,r);for(var a=new o(i,r),s=e;;){var h=Math.min(e+i,Math.floor(s+c/4/r)),d=alt1.bindGetRegion(t,s,n,h-s,r);if(!d)throw new l;if(f(d,a,s-e,0,h-s,r),(s=h)==e+i)break}return a}(this.handle,t,e,n,i)}}var o;function a(){try{return n(Object(function(){var t=new Error("Cannot find module 'sharp'");throw t.code="MODULE_NOT_FOUND",t}()))}catch(t){}return null}function s(){a();try{return n(Object(function(){var t=new Error("Cannot find module 'canvas'");throw t.code="MODULE_NOT_FOUND",t}()))}catch(t){}return null}!function(){var t="undefined"!=typeof self?self:void 0!==n.g?n.g:null,e=void 0===t.ImageData||void 0===t.document,i=e;if(!e){t.ImageData;try{let e=new Uint8ClampedArray(4);e[0]=1;let n=new t.ImageData(e,1,1);i=1!=n.data[0]}catch(t){i=!0}}if(i){var r=function(){var t=0,n=arguments[t]instanceof Uint8ClampedArray?arguments[t++]:null,r=arguments[t++],o=arguments[t++];if(e)n||(n=new Uint8ClampedArray(r*o*4)),this.width=r,this.height=o,this.data=n;else if(i){var a=document.createElement("canvas");a.width=r,a.height=o;var s=a.getContext("2d").createImageData(r,o);return n&&s.data.set(n),s}};e||(r.prototype=t.ImageData.prototype),t.ImageData=r,o=r}else o=t.ImageData}(),o.prototype.toDrawableData=function(){return"undefined"==typeof document?function(t){let e=s();if(!e)throw new Error("couldn't find built-in canvas or the module 'canvas'");return new e.ImageData(t.data,t.width,t.height)}(this):this},o.prototype.putImageData=function(t,e,n){for(var i=0;i<t.width;i++)for(var r=0;r<t.height;r++){var o=4*(i+e)+4*(r+n)*this.width,a=4*i+4*r*t.width;this.data[o]=t.data[a],this.data[o+1]=t.data[a+1],this.data[o+2]=t.data[a+2],this.data[o+3]=t.data[a+3]}},o.prototype.pixelOffset=function(t,e){return 4*t+e*this.width*4},o.prototype.getPixelHash=function(t){t||(t=new m(0,0,this.width,this.height));for(var e=0,n=t.x;n<t.x+t.width;n++)for(var i=t.y;i<t.y+t.height;i++){var r=4*n+4*i*this.width;e=((e=((e=((e=(e<<5)-e+this.data[r]|0)<<5)-e+this.data[r+1]|0)<<5)-e+this.data[r+2]|0)<<5)-e+this.data[r+3]|0}return e},o.prototype.clone=function(t){return this.toImage(t).getContext("2d").getImageData(0,0,t.width,t.height)},o.prototype.show=function(t=5,e=5,n=1){if("undefined"!=typeof document){for(var i=document.getElementsByClassName("debugimage");i.length>o.prototype.show.maxImages;)i[0].remove();var r=this.toImage();return r.classList.add("debugimage"),r.style.position="absolute",r.style.zIndex="1000",r.style.left=t/n+"px",r.style.top=e/n+"px",r.style.background="purple",r.style.cursor="pointer",r.style.imageRendering="pixelated",r.style.outline="1px solid #0f0",r.style.width=(1==this.width?100:this.width)*n+"px",r.style.height=(1==this.height?100:this.height)*n+"px",r.onclick=function(){r.remove()},document.body.appendChild(r),r}console.error("need a document to show an imagedata object")},o.prototype.show.maxImages=10,o.prototype.toImage=function(t){if(t||(t=new m(0,0,this.width,this.height)),"undefined"!=typeof document){var e=document.createElement("canvas");e.width=t.width,e.height=t.height}else e=function(t,e){let n=s();if(!n)throw new Error("couldn't find built-in canvas or the module 'canvas'");return n.createCanvas(t,e)}(t.width,t.height);return e.getContext("2d").putImageData(this.toDrawableData(),-t.x,-t.y),e},o.prototype.getPixel=function(t,e){var n=4*t+4*e*this.width;return[this.data[n],this.data[n+1],this.data[n+2],this.data[n+3]]},o.prototype.getPixelValueSum=function(t,e){var n=4*t+4*e*this.width;return this.data[n]+this.data[n+1]+this.data[n+2]},o.prototype.getPixelInt=function(t,e){var n=4*t+4*e*this.width;return(this.data[n+3]<<24)+(this.data[n+0]<<16)+(this.data[n+1]<<8)+(0|this.data[n+2])},o.prototype.getColorDifference=function(t,e,n,i,r,o=255){var a=4*t+4*e*this.width;return Math.abs(this.data[a]-n)+Math.abs(this.data[a+1]-i)+Math.abs(this.data[a+2]-r)*o/255},o.prototype.setPixel=function(t,e,...n){var i,r,o,a,[i,r,o,a]=Array.isArray(n[0])?n[0]:n,s=4*t+4*e*this.width;this.data[s]=i,this.data[s+1]=r,this.data[s+2]=o,this.data[s+3]=null==a?255:a},o.prototype.setPixelInt=function(t,e,n){var i=4*t+4*e*this.width;this.data[i]=n>>24&255,this.data[i+1]=n>>16&255,this.data[i+2]=n>>8&255,this.data[i+3]=255&n},o.prototype.toFileBytes=function(t,e){return"undefined"!=typeof HTMLCanvasElement?new Promise(n=>this.toImage().toBlob(t=>{var e=new FileReader;e.readAsArrayBuffer(t),e.onload=()=>n(new Uint8Array(e.result))},t,e)):function(t,e,i){return r=this,o=void 0,h=function*(){var r,o;if(r=function(){try{return n(Object(function(){var t=new Error("Cannot find module 'electron/common'");throw t.code="MODULE_NOT_FOUND",t}()))}catch(t){}return null}()){let e=r.nativeImage,n=Buffer.from(t.data.slice(t.data.byteOffset,t.data.byteLength));return function(t){for(let e=0;e<t.length;e+=4){let n=t[e+2];t[e+2]=t[e+0],t[e+0]=n}}(n),e.createFromBitmap(n,{width:t.width,height:t.height}).toPNG()}if(o=a()){let n=o(Buffer.from(t.data.buffer),{raw:{width:t.width,height:t.height,channels:4}});if("image/png"==e)n.png();else{if("image/webp"!=e)throw new Error("unknown image format: "+e);var s={quality:80};"number"==typeof i&&(s.quality=100*i),n.webp(s)}return yield n.toBuffer({resolveWithObject:!1}).buffer}throw new Error("coulnd't find build-in image compression methods or the module 'electron/common' or 'sharp'")},new((s=void 0)||(s=Promise))(function(t,e){function n(t){try{a(h.next(t))}catch(t){e(t)}}function i(t){try{a(h.throw(t))}catch(t){e(t)}}function a(e){var r;e.done?t(e.value):(r=e.value,r instanceof s?r:new s(function(t){t(r)})).then(n,i)}a((h=h.apply(r,o||[])).next())});var r,o,s,h}(this,t,e)},o.prototype.toPngBase64=function(){if("undefined"!=typeof HTMLCanvasElement){var t=this.toImage().toDataURL("image/png");return t.slice(t.indexOf(",")+1)}throw new Error("synchronous image conversion not supported in nodejs, try using ImageData.prototype.toFileBytes")},o.prototype.pixelCompare=function(t,e=0,n=0,i){return y(this,t,e,n,i)},o.prototype.copyTo=function(t,e,n,i,r,o,a){const s=0|t.width,h=0|this.width,l=0|i,d=4*Math.floor(i/4),c=new Int32Array(this.data.buffer,this.data.byteOffset,this.data.byteLength/4),u=new Int32Array(t.data.buffer,t.data.byteOffset,t.data.byteLength/4);for(let t=0;t<r;t++){let i=0,r=i+o+(t+a)*s,g=i+e+(t+n)*h;for(;i<d;i+=4)u[r]=c[g],u[r+1]=c[g+1],u[r+2]=c[g+2],u[r+3]=c[g+3],r+=4,g+=4;for(;i<l;i++)u[r]=c[g],r+=1,g+=1}},"undefined"!=typeof HTMLImageElement&&(HTMLImageElement.prototype.toBuffer=function(t=0,e=0,n=this.width,i=this.height){var r=document.createElement("canvas");r.width=n,r.height=i;var o=r.getContext("2d");return o.drawImage(this,-t,-e),o.getImageData(0,0,n,i)},HTMLImageElement.prototype.toCanvas=function(t=0,e=0,n=this.width,i=this.height){var r=document.createElement("canvas");return r.width=n,r.height=i,r.getContext("2d").drawImage(this,-t,-e),r});class h extends Error{constructor(){super(),this.message="This method can not be ran outside of Alt1"}}class l extends Error{}var d="undefined"!=typeof alt1,c=(d&&alt1.skinName,4e6);function u(){if(!d)throw new h}function g(){return function(t,e,n,i){t=Math.round(t),e=Math.round(e),n=Math.round(n),i=Math.round(i),u();var o=alt1.bindRegion(t,e,n,i);if(o<=0)throw new l("capturehold failed");return new r(o,t,e,n,i)}(0,0,alt1.rsWidth,alt1.rsHeight)}function f(t,e,n,i,r,o){var a=atob(t),s=e.data;r|=0,o|=0;for(var h=4*n+4*i*e.width,l=0|e.width,d=0;d<r;d++)for(var c=0;c<o;c++){var u=h+(4*d|0)+(c*l*4|0)|0,g=(4*d|0)+(4*c*r|0)|0;s[u+0|0]=a.charCodeAt(g+2|0),s[u+1|0]=a.charCodeAt(g+1|0),s[u+2|0]=a.charCodeAt(g+0|0),s[u+3|0]=a.charCodeAt(g+3|0)}return e}function y(t,e,n,i,r=30){if(n<0||i<0)throw new RangeError;if(n+e.width>t.width||i+e.height>t.height)throw new RangeError;-1==r&&(r=1020);for(var o=0,a=8;a>=1;a/=2)for(var s=0;s<e.width;s+=a)for(var h=0;h<e.height;h+=a){var l=4*(n+s)+(i+h)*t.width*4,d=4*s+h*e.width*4,c=0;if(c=(c=(c=c+Math.abs(t.data[l+0]-e.data[d+0])|0)+Math.abs(t.data[l+1]-e.data[d+1])|0)+Math.abs(t.data[l+2]-e.data[d+2])|0,c*=e.data[d+3]/255,1==a&&(o+=c),c>r)return 1/0}return o/e.width/e.height}class m{constructor(t,e,n,i){this.x=t,this.y=e,this.width=n,this.height=i}static fromArgs(...t){if("object"==typeof t[0])return new m(t[0].x,t[0].y,t[0].width,t[0].height);if("number"==typeof t[0]&&t.length>=4)return new m(t[0],t[1],t[2],t[3]);throw new Error("invalid rect args")}union(t){var e=Math.min(this.x,t.x),n=Math.min(this.y,t.y);return this.width=Math.max(this.x+this.width,t.x+t.width)-e,this.height=Math.max(this.y+this.height,t.y+t.height)-n,this.x=e,this.y=n,this}includePoint(t,e){this.union(new m(t,e,0,0))}inflate(t,e){this.x-=t,this.y-=e,this.width+=2*t,this.height+=2*e}intersect(t){this.x<t.x&&(this.width-=t.x-this.x,this.x=t.x),this.y<t.y&&(this.height-=t.y-this.y,this.y=t.y),this.width=Math.min(this.x+this.width,t.x+t.width)-this.x,this.height=Math.min(this.y+this.height,t.y+t.height)-this.y,(this.width<=0||this.height<=0)&&(this.width=0,this.height=0)}overlaps(t){return this.x<t.x+t.width&&this.x+this.width>t.x&&this.y<t.y+t.height&&this.y+this.height>t.y}contains(t){return this.x<=t.x&&this.x+this.width>=t.x+t.width&&this.y<=t.y&&this.y+this.height>=t.y+t.height}containsPoint(t,e){return this.x<=t&&this.x+this.width>t&&this.y<=e&&this.y+this.height>e}}function p(t){for(var e=t.width+2,n=new o(e*t.chars.length,t.height+1),i=0;i<n.data.length;i+=4)n.data[i]=n.data[i+1]=n.data[i+2]=0,n.data[i+3]=255;for(i=0;i<t.chars.length;i++)for(var r=i*e,a=t.chars[i],s=0;s<a.pixels.length;s+=t.shadow?4:3)n.setPixel(r+a.pixels[s],a.pixels[s+1],[a.pixels[s+2],a.pixels[s+2],a.pixels[s+2],255]),t.shadow&&n.setPixel(r+a.pixels[s],a.pixels[s+1],[a.pixels[s+3],0,0,255]);n.show()}function w(t,e,n,i,r,o,a){var s=Math.min(50,a/(1-a)),h=t+(t-i)*s,l=e+(e-r)*s,d=n+(n-o)*s;return Math.max(0,-h,-l,-d,h-255,l-255,d-255)}function v(t,e,n,i,r,o){var a=Math.sqrt(t*t+e*e+n*n),s=Math.sqrt(i*i+r*r+o*o),h=(t*i+e*r+n*o)/s,l=Math.sqrt(Math.max(0,a*a-h*h)),d=Math.max(0,4*(63.75-l)),c=h/s*255;return c>255&&(d=Math.max(0,d-c+255),c=255),[d,c]}function x(t,e,n,i,r,o,a){r-=e.basey;var s=e.basey,h=e.shadow,l=null,d=null;if(r<0||r+e.height>=t.height)return null;if(o){if(i-e.width<0||i>t.width)return null}else if(i<0||i+e.width>t.width)return null;for(var c=[],u=0;u<e.chars.length;u++){var g=e.chars[u];if(!g.secondary||a){c[u]={score:0,sizescore:0,chr:g};for(var f=o?i-g.width:i,y=0;y<g.pixels.length;){var m=4*(f+g.pixels[y])+(r+g.pixels[y+1])*t.width*4,p=0;if(h){var v=g.pixels[y+3]/255;p=w(t.data[m],t.data[m+1],t.data[m+2],n[0]*v,n[1]*v,n[2]*v,g.pixels[y+2]/255),y+=4}else p=w(t.data[m],t.data[m+1],t.data[m+2],n[0],n[1],n[2],g.pixels[y+2]/255),y+=3;c[u].score+=Math.max(0,p),d&&d.setPixel(g.pixels[y],g.pixels[y+1],[p,p,p,255])}c[u].sizescore=c[u].score-g.bonus,l&&l.push({chr:g.chr,score:c[u].sizescore,rawscore:c[u].score,img:d})}}c.sort((t,e)=>t.sizescore-e.sizescore);var x=c[0];return!x||x.score>400?null:{chr:x.chr.chr,basechar:x.chr,x:i+0,y:r+s,score:x.score,sizescore:x.sizescore}}function b(t){return t.replace(/[^\d]/g,"")}function R(t){try{const e=function(t,e,n,i,r,o,a=!1){"number"!=typeof n[0]&&1==n.length&&(n=n[0]);var s="number"!=typeof n[0],h=s?n:[n],l=function(n,i,r){var o=Math.floor(1.5*e.width);return r&&(n-=o),i-=e.basey,function(t,e,n){var i=-1,r=null,o=0,a=t.data;for(let u of n){for(var s=0,h=e.y;h<e.y+e.height;h++)for(var l=e.x;l<e.x+e.width;l++){if(l<0||l+1>=t.width)continue;if(h<0||h+1>=t.width)continue;let e=t.pixelOffset(l,h),n=t.pixelOffset(l+1,h+1);var d=v(a[e+0],a[e+1],a[e+2],u[0],u[1],u[2]),c=v(a[n+0],a[n+1],a[n+2],u[0],u[1],u[2]);s+=d[0]/255*d[1]/255*(c[0]/255*(255-c[1])/255)}s>i?(o=i,i=s,r=u):s>o&&(o=s)}return r}(t,{x:n,y:i,width:o,height:e.height},h)},d=[],c=i,u=i,g="number"==typeof e.maxspaces?e.maxspaces:1;let f="",y=!1;var m=null;let p=t=>{if(!f)return;let e={text:f,color:m,index:0,xstart:i+(t?R:M),xend:i+(t?M:R)};t?d.push(e):d.unshift(e),f="",R=b,y=!1};for(var w of[!0,!1])if((!w||o)&&(w||a)){for(var b=0,R=b,M=b,I=0,S=!1,C=s?null:n;;){var D=(C=C||l(i+b,r,!w))?x(t,e,C,i+b,r,!w,!0):null;if(null==C||null==D){if(I<g){b+=(w?1:-1)*e.spacewidth,I++;continue}if(s&&!S&&y){b-=(w?1:-1)*I*e.spacewidth,I=0,C=null,S=!0;continue}w?u=i+b-e.spacewidth:c=i+b+e.spacewidth;break}!m||C[0]==m[0]&&C[1]==m[1]&&C[2]==m[2]||p(w);for(var E="",k=0;k<I;k++)E+=" ";w?f+=E+D.chr:f=D.chr+E+f,D.basechar.secondary||(y=!0),I=0,S=!1,b+=(w?1:-1)*D.basechar.width,M=b,m=C}m&&y&&p(w)}return d.forEach((t,e)=>t.index=e),{debugArea:{x:c,y:r-9,w:u-c,h:10},text:d.map(t=>t.text).join(""),fragments:d}}(t,0,0,t.width,t.height,p,null);return e?.text?String(e.text):null}catch{return null}}function M(t){const e=R(t);if(!e)return null;const n=b(e);if(!n)return null;const i=Number(n);return Number.isFinite(i)&&i>0?i:null}function I(t){const e=t.data;let n=0;for(let t=0;t<e.length;t+=64)n=31*n+e[t]>>>0;return n.toString(16)}function S(t,e){const n=e?`${e.x},${e.y},${e.w},${e.h}`:"",i=prompt(`${t}\n\nEnter x,y,w,h (RS client pixels):`,n);if(!i)return null;const r=i.split(",").map(t=>Number(t.trim()));if(4!==r.length)return null;const[o,a,s,h]=r;return![o,a,s,h].every(Number.isFinite)||s<=0||h<=0?null:{x:o,y:a,w:s,h}}class C{constructor(t){this.runState="idle",this.slots=Array.from({length:28},()=>({sig:null,qty:null})),this.loot={},this.timer=null,this.updateCb=null,this.state=t,this.invRegion=t.settings.invRegion??null,this.moneyRegion=t.settings.moneyRegion??null}onUpdate(t){this.updateCb=t}hasInventoryRegion(){return!!this.invRegion}hasMoneyRegion(){return!!this.moneyRegion}getRunState(){return this.runState}getCurrentLoot(){return Object.values(this.loot).sort((t,e)=>e.qty-t.qty)}reset(){this.loot={},this.slots=this.slots.map(()=>({sig:null,qty:null}))}getDiagLine(){const t=window.alt1;return t?`alt1 ok | pixel=${!!t.permissionPixel} overlay=${!!t.permissionOverlay} rsLinked=${!!t.rsLinked}`:"alt1: not detected"}setInventoryRegion(t){this.invRegion=t,this.state.settings.invRegion=t,this.updateCb?.()}setMoneyRegion(t){this.moneyRegion=t,this.state.settings.moneyRegion=t,this.updateCb?.()}async calibrateInventoryRegion(){const t=S("Set Inventory Region",this.invRegion);return!!t&&(this.setInventoryRegion(t),!0)}async calibrateMoneyRegion(){const t=S("Set Money Region",this.moneyRegion);return!!t&&(this.setMoneyRegion(t),!0)}previewRegion(t,e){const n=e??("inv"===t?this.invRegion:this.moneyRegion);if(!n)return{dataUrl:null,error:"Region not set."};const i=g();if(!i)return{dataUrl:null,error:"captureHoldFullRs() returned null."};if("function"!=typeof i.crop)return{dataUrl:null,error:"Capture object has no crop() method."};let r;try{r=i.crop(n.x,n.y,n.w,n.h)}catch(t){return{dataUrl:null,error:`crop() threw: ${String(t?.message??t)}`}}const o=function(t){if("undefined"!=typeof ImageData&&t instanceof ImageData)return{img:t,why:"already ImageData"};try{if("function"==typeof t?.toData){const e=t.toData();if(e?.data&&"number"==typeof e.width&&"number"==typeof e.height)return{img:e,why:"toData()"}}}catch{}try{if("function"==typeof t?.getData){const e=t.getData();if(e?.data&&"number"==typeof e.width&&"number"==typeof e.height)return{img:e,why:"getData()"}}}catch{}try{if("function"==typeof t?.read){const e=t.width??t.w,n=t.height??t.h;if("number"==typeof e&&"number"==typeof n){const i=t.read(0,0,e,n);if(i?.data&&"number"==typeof i.width&&"number"==typeof i.height)return{img:i,why:"read(0,0,w,h)"}}}}catch{}try{if("function"==typeof t?.read){const e=t.read();if(e?.data&&"number"==typeof e.width&&"number"==typeof e.height)return{img:e,why:"read()"}}}catch{}return{img:null,why:"No usable ImageData conversion method found (toData/getData/read)"}}(r);if(!o.img)return{dataUrl:null,error:o.why};const a=function(t){try{const e=document.createElement("canvas");e.width=t.width,e.height=t.height;const n=e.getContext("2d");return n?(n.putImageData(t,0,0),e.toDataURL("image/png")):null}catch{return null}}(o.img);return a?{dataUrl:a,error:null}:{dataUrl:null,error:"Canvas conversion failed (toDataURL)."}}start(t){this.invRegion?(this.runState="running",this.reset(),this.captureAndUpdate(!0),this.timer&&window.clearInterval(this.timer),this.timer=window.setInterval(()=>{"running"===this.runState&&this.captureAndUpdate(!1)},600),this.state.activeSession={id:crypto.randomUUID(),label:t,startedAt:Date.now(),endedAt:null,loot:[]},this.updateCb?.()):alert("Inventory region not set.")}togglePause(){"idle"!==this.runState&&(this.runState="paused"===this.runState?"running":"paused",this.updateCb?.())}stop(){if("idle"===this.runState)return;this.runState="idle",this.timer&&(window.clearInterval(this.timer),this.timer=null);const t=this.state.activeSession;t&&(t.endedAt=Date.now(),t.loot=this.getCurrentLoot(),this.state.sessions.unshift(t),this.state.activeSession=null),this.updateCb?.()}captureAndUpdate(t){if(!this.invRegion)return;const e=g();if(!e||"function"!=typeof e.crop)return;const n=Math.floor(this.invRegion.w/4),i=Math.floor(this.invRegion.h/7);for(let r=0;r<28;r++){const o=r%4,a=Math.floor(r/4),s=this.invRegion.x+o*n,h=this.invRegion.y+a*i,l=e.crop(s+2,h+Math.floor(.22*i),n-4,i-4),d=e.crop(s+1,h+1,Math.floor(.7*n),Math.floor(.4*i)),c=I(l),u=M(d);this.applySlotUpdate(r,c,u,t)}if(!t&&this.moneyRegion){const t=function(t){const e=R(t);if(!e)return null;if(!e.includes("+"))return null;const n=b(e);if(!n)return null;const i=Number(n);return Number.isFinite(i)&&i>0?i:null}(e.crop(this.moneyRegion.x,this.moneyRegion.y,this.moneyRegion.w,this.moneyRegion.h));t&&this.addLoot("coins:pouch","Coins (Money Pouch)",t)}this.updateCb?.()}applySlotUpdate(t,e,n,i){const r=this.slots[t];if(!e||null===n)return;const o=r.sig,a=r.qty;r.sig=e,r.qty=n,i||(o===e&&null!==a?n>a&&this.addLoot(e,this.displayName(e),n-a):this.addLoot(e,this.displayName(e),n))}addLoot(t,e,n){n<=0||(this.loot[t]||(this.loot[t]={key:t,name:e,qty:0,iconSig:t}),this.loot[t].qty+=n,this.state.activeSession&&(this.state.activeSession.loot=this.getCurrentLoot()))}displayName(t){return this.state.iconNames[t]??`Unidentified (${t.slice(0,6)})`}}const D="alt1_loot_tracker_state_v1";function E(t,e){const n=document.getElementById(t);n&&(n.textContent=e)}function k(t){const e=document.getElementById(t);if(!e)throw new Error(`Missing element #${t}`);return e}function N(t){E("lastAction",`last: ${t}`),console.log("[LootTracker]",t)}window.onerror=(t,e,n,i,r)=>{const o=`JS error: ${String(t)} @ ${String(e)}:${n}:${i}`;return console.error(o,r),alert(o),!1},window.onunhandledrejection=t=>{const e=`Unhandled promise rejection: ${String(t?.reason??t)}`;console.error(e,t),alert(e)},window.addEventListener("load",()=>{N("window load");const t=function(){const t=localStorage.getItem(D);if(t)try{const e=JSON.parse(t);return{settings:{invRegion:e.settings?.invRegion??null,moneyRegion:e.settings?.moneyRegion??null},iconNames:e.iconNames??{},sessions:e.sessions??[],activeSession:null}}catch{}return{settings:{invRegion:null,moneyRegion:null},iconNames:{},sessions:[],activeSession:null}}(),e=new C(t),n=k("sessionLabel");function i(t){const e=Number(k(`${t}X`).value),n=Number(k(`${t}Y`).value),i=Number(k(`${t}W`).value),r=Number(k(`${t}H`).value);return![e,n,i,r].every(Number.isFinite)||i<=0||r<=0?null:{x:e,y:n,w:i,h:r}}function r(){t.settings.invRegion&&(k("invX").value=String(t.settings.invRegion.x),k("invY").value=String(t.settings.invRegion.y),k("invW").value=String(t.settings.invRegion.w),k("invH").value=String(t.settings.invRegion.h)),t.settings.moneyRegion&&(k("monX").value=String(t.settings.moneyRegion.x),k("monY").value=String(t.settings.moneyRegion.y),k("monW").value=String(t.settings.moneyRegion.w),k("monH").value=String(t.settings.moneyRegion.h))}function o(t,e){const n=k(t);e?n.src=e:n.removeAttribute("src")}function a(n){E("statusInv",e.hasInventoryRegion()?"Inventory: set":"Inventory: not set"),E("statusMoney",e.hasMoneyRegion()?"Money: set":"Money: not set"),E("statusRun",`Status: ${e.getRunState()}`);const i=e.getDiagLine();E("diag",n?`${i} | ${n}`:i);const r=k("btnStart"),o=k("btnPause"),a=k("btnStop");r.disabled="idle"!==e.getRunState(),o.disabled="idle"===e.getRunState(),a.disabled="idle"===e.getRunState(),function(t){const e=document.getElementById("lootRows");e.innerHTML="";for(const n of t){const t=document.createElement("tr");t.dataset.sig=n.iconSig??"";const i=document.createElement("td");if(n.iconSig){const t=document.createElement("img");t.className="loot-icon",t.alt=n.name,t.dataset.sig=n.iconSig,i.appendChild(t)}else i.textContent="â€”";const r=document.createElement("td");r.textContent=n.name;const o=document.createElement("td");o.className="right",o.textContent=n.qty.toLocaleString(),t.appendChild(i),t.appendChild(r),t.appendChild(o),e.appendChild(t)}}(e.getCurrentLoot()),function(t){const e=document.getElementById("sessionRows");e.innerHTML="";for(const n of t.slice(0,20)){const t=document.createElement("tr"),i=document.createElement("td");i.textContent=new Date(n.startedAt).toLocaleString();const r=document.createElement("td");r.textContent=n.label;const o=document.createElement("td");o.className="right",o.textContent=String(n.loot.length),t.appendChild(i),t.appendChild(r),t.appendChild(o),e.appendChild(t)}}(t.sessions),function(t){localStorage.setItem(D,JSON.stringify({settings:t.settings,iconNames:t.iconNames,sessions:t.sessions}))}(t)}k("btnCalibInv").onclick=async()=>{N("clicked: calib inv");const t=await e.calibrateInventoryRegion();t&&r(),a(t?"inv set":"inv cancel")},k("btnCalibMoney").onclick=async()=>{N("clicked: calib money");const t=await e.calibrateMoneyRegion();t&&r(),a(t?"money set":"money cancel")},k("btnSetInv").onclick=()=>{N("clicked: set inv");const t=i("inv");if(!t)return alert("Invalid inventory rect.");e.setInventoryRegion(t),a("inv set")},k("btnPreviewInv").onclick=()=>{N("clicked: preview inv"),alert("Preview INV clicked (handler is running).");const t=i("inv");if(!t)return alert("Invalid inventory rect.");const n=e.previewRegion("inv",t);o("imgInv",n.dataUrl),n.error&&alert(n.error),a(n.error?`inv preview: ${n.error}`:"inv preview ok")},k("btnSetMoney").onclick=()=>{N("clicked: set money");const t=i("mon");if(!t)return alert("Invalid money rect.");e.setMoneyRegion(t),a("money set")},k("btnPreviewMoney").onclick=()=>{N("clicked: preview money"),alert("Preview MONEY clicked (handler is running).");const t=i("mon");if(!t)return alert("Invalid money rect.");const n=e.previewRegion("money",t);o("imgMoney",n.dataUrl),n.error&&alert(n.error),a(n.error?`money preview: ${n.error}`:"money preview ok")},k("btnStart").onclick=()=>{N("clicked: start"),e.start(n.value.trim()||"Unnamed"),a("started")},k("btnPause").onclick=()=>{N("clicked: pause"),e.togglePause(),a("pause toggled")},k("btnStop").onclick=()=>{N("clicked: stop"),e.stop(),a("stopped")},k("btnClearAll").onclick=()=>{N("clicked: clear all"),confirm("Clear all saved sessions and names?")&&(t.sessions=[],t.iconNames={},e.reset(),a("cleared"))},e.onUpdate(()=>a()),r(),a("boot ok")})})();
//# sourceMappingURL=bundle.js.map